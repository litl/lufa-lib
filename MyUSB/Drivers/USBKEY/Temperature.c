/*
             MyUSB Library
     Copyright (C) Dean Camera, 2007.
              
  dean [at] fourwalledcubicle [dot] com
      www.fourwalledcubicle.com

 Released under the GPL Licence, Version 3
*/

#include "Temperature.h"

const uint16_t Temperature_Lookup[] PROGMEM = {
   0x3B4, 0x3B0, 0x3AB, 0x3A6, 0x3A0, 0x39A, 0x394, 0x38E, 0x388, 0x381, 0x37A, 0x373,
   0x36B, 0x363, 0x35B, 0x353, 0x34A, 0x341, 0x338, 0x32F, 0x325, 0x31B, 0x311, 0x307,
   0x2FC, 0x2F1, 0x2E6, 0x2DB, 0x2D0, 0x2C4, 0x2B8, 0x2AC, 0x2A0, 0x294, 0x288, 0x27C,
   0x26F, 0x263, 0x256, 0x24A, 0x23D, 0x231, 0x225, 0x218, 0x20C, 0x200, 0x1F3, 0x1E7,
   0x1DB, 0x1CF, 0x1C4, 0x1B8, 0x1AC, 0x1A1, 0x196, 0x18B, 0x180, 0x176, 0x16B, 0x161,
   0x157, 0x14D, 0x144, 0x13A, 0x131, 0x128, 0x11F, 0x117, 0x10F, 0x106, 0xFE , 0xF7 ,
   0xEF , 0xE8 , 0xE1 , 0xDA , 0xD3 , 0xCD , 0xC7 , 0xC0 , 0xBA , 0xB5 , 0xAF , 0xAA ,
   0xA4 , 0x9F , 0x9A , 0x96 , 0x91 , 0x8C , 0x88 , 0x84 , 0x80 , 0x7C , 0x78 , 0x74 ,
   0x71 , 0x6D , 0x6A , 0x67 , 0x64 , 0x61 , 0x5E , 0x5B , 0x58 , 0x55 , 0x53 , 0x50 ,
   0x4E , 0x4C , 0x49 , 0x47 , 0x45 , 0x43 , 0x41 , 0x3F , 0x3D , 0x3C , 0x3A , 0x38
   };

int8_t Temperature_GetTemperature(void)
{
	uint16_t Temp_ADC = ADC_GetChannelReading(TEMP_ADC_CHANNEL);

	if (Temp_ADC > pgm_read_word(&Temperature_Lookup[0]))
	  return TEMP_MIN_TEMP;

	for (uint16_t Index = 0; Index < TEMP_TABLE_SIZE; Index++)
	{
		if (Temp_ADC > pgm_read_word(&Temperature_Lookup[Index]))
		 return ((Index - 1) + TEMP_TABLE_OFFSET);
	}

	return TEMP_MAX_TEMP;
}
